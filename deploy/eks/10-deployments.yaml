apiVersion: apps/v1
kind: Deployment
metadata:
  name: canonical-api
  namespace: nvariant
spec:
  replicas: 2
  selector:
    matchLabels: { app: canonical-api }
  template:
    metadata:
      labels: { app: canonical-api }
    spec:
      serviceAccountName: nvariant-sa
      terminationGracePeriodSeconds: 30
      containers:
        - name: canonical-api
          image: registry.io/nvariant/canonical-api:latest
          ports:
            - containerPort: 3000
          envFrom:
            - configMapRef: { name: nvariant-config }
            - secretRef: { name: nvariant-secrets }
          readinessProbe:
            httpGet: { path: /health/ready, port: 3000 }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/live, port: 3000 }
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: contract-registry
  namespace: nvariant
spec:
  replicas: 2
  selector:
    matchLabels: { app: contract-registry }
  template:
    metadata:
      labels: { app: contract-registry }
    spec:
      serviceAccountName: nvariant-sa
      terminationGracePeriodSeconds: 30
      containers:
        - name: contract-registry
          image: registry.io/nvariant/contract-registry:latest
          ports:
            - containerPort: 7001
          envFrom:
            - configMapRef: { name: nvariant-config }
            - secretRef: { name: nvariant-secrets }
          readinessProbe:
            httpGet: { path: /health/ready, port: 7001 }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/live, port: 7001 }
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: enforcement
  namespace: nvariant
spec:
  replicas: 2
  selector:
    matchLabels: { app: enforcement }
  template:
    metadata:
      labels: { app: enforcement }
    spec:
      serviceAccountName: nvariant-sa
      terminationGracePeriodSeconds: 30
      containers:
        - name: enforcement
          image: registry.io/nvariant/enforcement:latest
          ports:
            - containerPort: 7004
          envFrom:
            - configMapRef: { name: nvariant-config }
            - secretRef: { name: nvariant-secrets }
          readinessProbe:
            httpGet: { path: /health/ready, port: 7004 }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/live, port: 7004 }
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: observation
  namespace: nvariant
spec:
  replicas: 2
  selector:
    matchLabels: { app: observation }
  template:
    metadata:
      labels: { app: observation }
    spec:
      serviceAccountName: nvariant-sa
      terminationGracePeriodSeconds: 30
      containers:
        - name: observation
          image: registry.io/nvariant/observation:latest
          ports:
            - containerPort: 7008
          envFrom:
            - configMapRef: { name: nvariant-config }
            - secretRef: { name: nvariant-secrets }
          readinessProbe:
            httpGet: { path: /health/ready, port: 7008 }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/live, port: 7008 }
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: lineage
  namespace: nvariant
spec:
  replicas: 2
  selector:
    matchLabels: { app: lineage }
  template:
    metadata:
      labels: { app: lineage }
    spec:
      serviceAccountName: nvariant-sa
      terminationGracePeriodSeconds: 30
      containers:
        - name: lineage
          image: registry.io/nvariant/lineage:latest
          ports:
            - containerPort: 7006
          envFrom:
            - configMapRef: { name: nvariant-config }
            - secretRef: { name: nvariant-secrets }
          readinessProbe:
            httpGet: { path: /health/ready, port: 7006 }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /health/live, port: 7006 }
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
