services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: nvariant
      POSTGRES_USER: nvariant
      POSTGRES_PASSWORD: nvariant
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nvariant -d nvariant"]
      interval: 5s
      timeout: 5s
      retries: 20

  contract-registry:
    build:
      context: services/contract-registry
    environment:
      INTERNAL_JWT_SECRET: dev
      DATABASE_URL: postgres://nvariant:nvariant@db:5432/nvariant
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "7001:7001"

  enforcement:
    build:
      context: services/enforcement
    environment:
      INTERNAL_JWT_SECRET: dev
      DATABASE_URL: postgres://nvariant:nvariant@db:5432/nvariant
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "7004:7004"

  observation:
    build:
      context: services/observation
    environment:
      INTERNAL_JWT_SECRET: dev
      DATABASE_URL: postgres://nvariant:nvariant@db:5432/nvariant
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "7008:7008"

  lineage:
    build:
      context: services/lineage
    environment:
      INTERNAL_JWT_SECRET: dev
      DATABASE_URL: postgres://nvariant:nvariant@db:5432/nvariant
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "7006:7006"

  canonical-api:
    build:
      context: services/canonical-api
    environment:
      INTERNAL_JWT_SECRET: dev
      DEV_AUTH: "1"
      CONTRACT_REGISTRY_URL: http://contract-registry:7001
      ENFORCEMENT_URL: http://enforcement:7004
      OBSERVATION_URL: http://observation:7008
      LINEAGE_URL: http://lineage:7006
    depends_on:
      contract-registry:
        condition: service_started
      enforcement:
        condition: service_started
      observation:
        condition: service_started
      lineage:
        condition: service_started
    ports:
      - "3000:3000"

  explorer-ui:
    build:
      context: apps/explorer-ui
    environment:
      VITE_API_BASE: http://localhost:3000
      VITE_DEV_AUTH: "1"
    depends_on:
      canonical-api:
        condition: service_started
    ports:
      - "3100:80"

  control-plane-ui:
    build:
      context: apps/control-plane-ui
    environment:
      VITE_API_BASE: http://localhost:3000
      VITE_DEV_AUTH: "1"
    depends_on:
      canonical-api:
        condition: service_started
    ports:
      - "3200:80"
