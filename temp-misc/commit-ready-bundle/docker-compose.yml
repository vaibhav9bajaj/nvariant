version: "3.9"

# nvariant local docker compose
# - Designed to match docs/quickstart.md + Makefile targets.
# - Assumes each zip service has a Dockerfile at:
#     zip-1/Dockerfile, zip-4/Dockerfile, zip-8/Dockerfile
# - Uses a single Postgres container with multiple databases created at startup.

services:
  postgres:
    image: postgres:16-alpine
    container_name: nvariant-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-nvariant}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nvariant}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      # Create additional DBs on first boot (init script reads this)
      NV_EXTRA_DBS: ${NV_EXTRA_DBS:-contracts,enforcement,observation,lineage}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - nvariant_pgdata:/var/lib/postgresql/data
      - ./scripts/postgres/init-multi-db.sh:/docker-entrypoint-initdb.d/01-init-multi-db.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nvariant} -d ${POSTGRES_DB:-postgres}"]
      interval: 3s
      timeout: 3s
      retries: 20

  zip-1:
    build:
      context: ./zip-1
      dockerfile: Dockerfile
    container_name: nvariant-zip-1
    env_file:
      - .env.local
    environment:
      # Allow overriding via .env.local; fall back to local defaults.
      CONTRACT_DB_URL: ${CONTRACT_DB_URL:-postgres://nvariant:nvariant@postgres:5432/contracts}
      NV_TENANT_ID: ${NV_TENANT_ID:-local}
      NV_ENV: ${NV_ENV:-local}
      PORT: ${CONTRACT_REGISTRY_PORT:-7001}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${CONTRACT_REGISTRY_PORT:-7001}:7001"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7001/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  zip-4:
    build:
      context: ./zip-4
      dockerfile: Dockerfile
    container_name: nvariant-zip-4
    env_file:
      - .env.local
    environment:
      ENFORCEMENT_DB_URL: ${ENFORCEMENT_DB_URL:-postgres://nvariant:nvariant@postgres:5432/enforcement}
      NV_TENANT_ID: ${NV_TENANT_ID:-local}
      NV_ENV: ${NV_ENV:-local}
      PORT: ${ENFORCEMENT_PORT:-7004}
      # Registry host for version resolution / contract fetches if needed by implementation
      CONTRACT_REGISTRY_URL: ${CONTRACT_REGISTRY_URL:-http://zip-1:7001}
    depends_on:
      postgres:
        condition: service_healthy
      zip-1:
        condition: service_healthy
    ports:
      - "${ENFORCEMENT_PORT:-7004}:7004"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7004/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  zip-8:
    build:
      context: ./zip-8
      dockerfile: Dockerfile
    container_name: nvariant-zip-8
    env_file:
      - .env.local
    environment:
      OBSERVATION_DB_URL: ${OBSERVATION_DB_URL:-postgres://nvariant:nvariant@postgres:5432/observation}
      NV_TENANT_ID: ${NV_TENANT_ID:-local}
      NV_ENV: ${NV_ENV:-local}
      PORT: ${OBSERVATION_PORT:-7008}
      CONTRACT_REGISTRY_URL: ${CONTRACT_REGISTRY_URL:-http://zip-1:7001}
      ENFORCEMENT_URL: ${ENFORCEMENT_URL:-http://zip-4:7004}
      LINEAGE_URL: ${LINEAGE_URL:-http://zip-6:7006}
    depends_on:
      postgres:
        condition: service_healthy
      zip-1:
        condition: service_healthy
      zip-4:
        condition: service_healthy
    ports:
      - "${OBSERVATION_PORT:-7008}:7008"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7008/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  # Optional: enable if you have lineage service running locally
  zip-6:
    build:
      context: ./zip-6
      dockerfile: Dockerfile
    container_name: nvariant-zip-6
    profiles: ["lineage"]
    env_file:
      - .env.local
    environment:
      LINEAGE_DB_URL: ${LINEAGE_DB_URL:-postgres://nvariant:nvariant@postgres:5432/lineage}
      NV_TENANT_ID: ${NV_TENANT_ID:-local}
      NV_ENV: ${NV_ENV:-local}
      PORT: ${LINEAGE_PORT:-7006}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${LINEAGE_PORT:-7006}:7006"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7006/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  nvariant_pgdata:
